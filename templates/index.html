<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>800g OSFPå…‰æ¨¡å—ç”Ÿäº§æ•°æ®åˆ†æå·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            border-left: 4px solid #3498db;
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
        }

        .section h2::before {
            content: '';
            width: 20px;
            height: 20px;
            background: #3498db;
            border-radius: 50%;
            margin-right: 10px;
        }

        .upload-area {
            border: 2px dashed #3498db;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            background: #ecf0f1;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            background: #d5dbdb;
            border-color: #2980b9;
        }

        .upload-area.dragover {
            background: #d5f4fd;
            border-color: #16a085;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: #3498db;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s ease;
            margin: 10px;
        }

        .upload-btn:hover {
            background: #2980b9;
        }

        .file-list {
            margin-top: 10px;
            text-align: left;
        }

        .file-item {
            background: white;
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 5px;
            border: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .config-panel {
            background: #2c3e50;
            color: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .config-row {
            margin-bottom: 15px;
        }

        .config-row label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .config-row input, .config-row textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .config-row textarea {
            height: 100px;
            resize: vertical;
        }

        .action-buttons {
            text-align: center;
            padding: 30px 0;
        }

        .btn {
            background: #27ae60;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            margin: 0 10px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #229954;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        .btn.secondary {
            background: #e74c3c;
        }

        .btn.secondary:hover {
            background: #c0392b;
        }

        .results {
            margin-top: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #27ae60;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .analysis-report {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid #ddd;
        }

        .chart-container {
            margin: 20px 0;
            text-align: center;
        }

        .chart-container img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2980b9);
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>800g OSFPå…‰æ¨¡å—ç”Ÿäº§æ•°æ®åˆ†æå·¥å…·</h1>
            <p>AIé©±åŠ¨çš„æ ¹æœ¬åŸå› åˆ†æ(RCA)ç³»ç»Ÿ</p>
        </div>

        <div class="main-content">
            <!-- é…ç½®é¢æ¿ -->
            <div class="config-panel">
                <h2 style="color: white;">é…ç½®è®¾ç½®</h2>
                <div class="config-row">
                    <label for="api-key">OpenAI API Key:</label>
                    <input type="password" id="api-key" placeholder="è¯·è¾“å…¥æ‚¨çš„OpenAI APIå¯†é’¥">
                </div>
                <div class="config-row">
                    <label for="api-url">API URL:</label>
                    <input type="text" id="api-url" value="https://api.openai.com/v1/chat/completions" placeholder="APIåœ°å€">
                    <select onchange="setApiPreset(this.value)" style="margin-top: 5px; width: 100%; padding: 5px;">
                        <option value="">é€‰æ‹©é¢„è®¾APIé…ç½®...</option>
                        <option value="openai">OpenAIå®˜æ–¹</option>
                        <option value="aigcbest">AIå·¥å‚(aigcbest.top)</option>
                        <option value="chatanywhere">ChatAnyWhere</option>
                        <option value="api2d">API2D</option>
                        <option value="custom">è‡ªå®šä¹‰</option>
                    </select>
                </div>
                <div class="config-row">
                    <label for="model">æ¨¡å‹:</label>
                    <select id="model" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="gpt-4">GPT-4</option>
                        <option value="gpt-4o">GPT-4o</option>
                        <option value="gpt-4o-mini">GPT-4o Mini</option>
                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                        <option value="o3">O3 (ç¬¬ä¸‰æ–¹)</option>
                        <option value="claude-3-opus">Claude 3 Opus</option>
                        <option value="claude-3-sonnet">Claude 3 Sonnet</option>
                    </select>
                    <button onclick="fetchAvailableModels()" style="margin-top: 5px; padding: 5px 10px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer;">è·å–å¯ç”¨æ¨¡å‹</button>
                </div>
                <div class="config-row">
                    <label for="max-tokens">æœ€å¤§Tokenæ•°:</label>
                    <input type="number" id="max-tokens" value="10000" min="100" max="100000" placeholder="æœ€å¤§è¾“å‡ºTokenæ•°">
                    <small style="color: #7f8c8d; display: block; margin-top: 5px;">
                        å»ºè®®èŒƒå›´: 1000-50000ï¼Œæ•°å€¼è¶Šå¤§è¾“å‡ºè¶Šè¯¦ç»†ä½†æ¶ˆè€—æ›´å¤šToken
                    </small>
                </div>
                <div class="config-row">
                    <label for="temperature">æ¸©åº¦å‚æ•°:</label>
                    <input type="number" id="temperature" value="0.7" min="0" max="2" step="0.1" placeholder="åˆ›é€ æ€§å‚æ•°">
                    <small style="color: #7f8c8d; display: block; margin-top: 5px;">
                        0.0=ç¡®å®šæ€§è¾“å‡º, 1.0=åˆ›é€ æ€§è¾“å‡º, å»ºè®®: 0.3-0.8
                    </small>
                </div>
                <div class="config-row">
                    <label for="system-prompt">ç³»ç»Ÿæç¤ºè¯:</label>
                    <textarea id="system-prompt" placeholder="è‡ªå®šä¹‰åˆ†ææç¤ºè¯">ä½ æ˜¯ä¸€åä¸“ä¸šçš„QAå’ŒQCä¸»ç®¡ï¼Œä¸“é—¨è´Ÿè´£800g OSFPå…‰æ¨¡å—çš„ç”Ÿäº§è´¨é‡åˆ†æã€‚
è¯·åŸºäºæä¾›çš„ç”Ÿäº§æ•°æ®è¿›è¡Œæ ¹æœ¬åŸå› åˆ†æ(RCA)ï¼Œé‡ç‚¹å…³æ³¨ï¼š
1. è´´ç‰‡å·¥è‰ºçš„å‚æ•°å¼‚å¸¸
2. å¼•çº¿é”®åˆçš„å·¥è‰ºç¨³å®šæ€§
3. lensè€¦åˆçš„å…‰å­¦å¯¹å‡†ç²¾åº¦
4. å„å·¥åºé—´çš„å…³è”æ€§åˆ†æ
5. ç»“åˆå…‰æ¨¡å—å·¥ä½œåŸç†åˆ†æå¤±æ•ˆæœºåˆ¶

è¯·æä¾›è¯¦ç»†çš„åˆ†ææŠ¥å‘Šï¼ŒåŒ…å«å…·ä½“çš„æ”¹è¿›å»ºè®®ã€‚</textarea>
                </div>
                <button class="upload-btn" onclick="updateConfig()">ä¿å­˜é…ç½®</button>
                <button class="upload-btn" onclick="testAIConnection()" style="background: #f39c12;">æµ‹è¯•AIè¿æ¥</button>
            </div>

            <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
            <div class="section">
                <h2>è´´ç‰‡æ•°æ®ä¸Šä¼ </h2>
                <div class="upload-area" onclick="document.getElementById('smt-files').click()">
                    <p>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ è´´ç‰‡å·¥è‰ºæ•°æ®æ–‡ä»¶ (Excel)</p>
                    <button class="upload-btn">é€‰æ‹©æ–‡ä»¶</button>
                    <input type="file" id="smt-files" class="file-input" multiple accept=".xlsx,.xls">
                </div>
                <div id="smt-file-list" class="file-list"></div>
            </div>

            <div class="section">
                <h2>å¼•çº¿é”®åˆæ•°æ®ä¸Šä¼ </h2>
                <div class="upload-area" onclick="document.getElementById('wire-bonding-files').click()">
                    <p>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å¼•çº¿é”®åˆå·¥è‰ºæ•°æ®æ–‡ä»¶ (Excel)</p>
                    <button class="upload-btn">é€‰æ‹©æ–‡ä»¶</button>
                    <input type="file" id="wire-bonding-files" class="file-input" multiple accept=".xlsx,.xls">
                </div>
                <div id="wire-bonding-file-list" class="file-list"></div>
            </div>

            <div class="section">
                <h2>Lensè€¦åˆæ•°æ®ä¸Šä¼ </h2>
                <div class="upload-area" onclick="document.getElementById('lens-coupling-files').click()">
                    <p>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ Lensè€¦åˆå·¥è‰ºæ•°æ®æ–‡ä»¶ (Excel)</p>
                    <button class="upload-btn">é€‰æ‹©æ–‡ä»¶</button>
                    <input type="file" id="lens-coupling-files" class="file-input" multiple accept=".xlsx,.xls">
                </div>
                <div id="lens-coupling-file-list" class="file-list"></div>
            </div>

            <div class="section">
                <h2>SNæ˜ å°„å…³ç³»ä¸Šä¼ </h2>
                <div class="upload-area" onclick="document.getElementById('sn-mapping-files').click()">
                    <p>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ PCBA SNä¸å£³ä½“SNæ˜ å°„å…³ç³»æ–‡ä»¶ (Excel)</p>
                    <button class="upload-btn">é€‰æ‹©æ–‡ä»¶</button>
                    <input type="file" id="sn-mapping-files" class="file-input" multiple accept=".xlsx,.xls">
                </div>
                <div id="sn-mapping-file-list" class="file-list"></div>
            </div>

            <div class="section">
                <h2>æµ‹è¯•ç»“æœæ•°æ®ä¸Šä¼ </h2>
                <div class="upload-area" onclick="document.getElementById('test-results-files').click()">
                    <p>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ æµ‹è¯•ç»“æœæ•°æ®æ–‡ä»¶ (Excel)</p>
                    <button class="upload-btn">é€‰æ‹©æ–‡ä»¶</button>
                    <input type="file" id="test-results-files" class="file-input" multiple accept=".xlsx,.xls">
                </div>
                <div id="test-results-file-list" class="file-list"></div>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="action-buttons">
                <button class="btn" id="upload-btn" onclick="uploadFiles()">ä¸Šä¼ å¹¶åˆ†ææ•°æ®</button>
                <button class="btn secondary" id="ai-analyze-btn" onclick="analyzeWithAI()" disabled>AIæ·±åº¦åˆ†æ</button>
                <button class="btn secondary" id="ai-stream-btn" onclick="analyzeWithAIStream()" disabled>AIæµå¼åˆ†æ</button>
            </div>

            <!-- è¿›åº¦æ¡ -->
            <div class="progress-bar" id="progress-bar" style="display: none;">
                <div class="progress-fill" id="progress-fill"></div>
            </div>

            <!-- æ—¥å¿—æ˜¾ç¤ºåŒºåŸŸ -->
            <div id="log-container" class="section" style="display: none;">
                <h2>å¤„ç†æ—¥å¿—
                    <button class="upload-btn" onclick="clearLogs()" style="float: right; margin: 0; padding: 8px 15px; font-size: 12px;">æ¸…é™¤æ—¥å¿—</button>
                    <button class="upload-btn" onclick="refreshLogs()" style="float: right; margin: 0; padding: 8px 15px; font-size: 12px; margin-right: 10px; background: #3498db;">åˆ·æ–°æ—¥å¿—</button>
                    <button class="upload-btn" onclick="toggleAutoRefresh()" id="auto-refresh-btn" style="float: right; margin: 0; padding: 8px 15px; font-size: 12px; margin-right: 10px; background: #27ae60;">è‡ªåŠ¨åˆ·æ–°</button>
                </h2>
                <div id="log-content" style="background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 5px; max-height: 300px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.4;"></div>
            </div>

            <!-- åŠ è½½çŠ¶æ€ -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>æ­£åœ¨å¤„ç†æ•°æ®ï¼Œè¯·ç¨å€™...</p>
            </div>

            <!-- AIåˆ†ææŠ¥å‘Šä¸“åŒº -->
            <div id="ai-analysis-section" class="section" style="display: none; border-left: 4px solid #e74c3c;">
                <h2>ğŸ¤– AIæ·±åº¦åˆ†ææŠ¥å‘Š</h2>
                <div id="ai-analysis-status" class="alert success" style="display: none;">
                    <strong>AIåˆ†æçŠ¶æ€ï¼š</strong><span id="ai-status-text">ç­‰å¾…å¼€å§‹åˆ†æ...</span>
                </div>
                <div id="ai-analysis-content" style="
                    background: white; 
                    border-radius: 8px; 
                    padding: 20px; 
                    margin-top: 15px;
                    border: 2px dashed #ddd;
                    text-align: center;
                    color: #7f8c8d;
                    min-height: 120px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    flex-direction: column;
                ">
                    <div style="font-size: 48px; margin-bottom: 15px;">ğŸ¤”</div>
                    <div style="font-size: 16px; margin-bottom: 10px;">AIåˆ†ææŠ¥å‘Šå°†åœ¨è¿™é‡Œæ˜¾ç¤º</div>
                    <div style="font-size: 14px; color: #95a5a6;">è¯·å…ˆä¸Šä¼ æ•°æ®æ–‡ä»¶ï¼Œç„¶åç‚¹å‡»"AIæ·±åº¦åˆ†æ"æŒ‰é’®</div>
                </div>
            </div>

            <!-- ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
            <div id="results" class="results" style="display: none;">
                <h2>ğŸ“Š åŸºç¡€æ•°æ®åˆ†æç»“æœ</h2>
                <div id="alert-container"></div>
                <div id="analysis-content"></div>
            </div>
        </div>
    </div>

    <script>
        let uploadedFiles = {
            'smt': [],
            'wire_bonding': [],
            'lens_coupling': [],
            'sn_mapping': [],
            'test_results': []
        };

        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        function setupFileUpload(inputId, listId, section) {
            const input = document.getElementById(inputId);
            const listDiv = document.getElementById(listId);

            input.addEventListener('change', function(e) {
                const files = Array.from(e.target.files);
                files.forEach(file => {
                    if (!uploadedFiles[section].some(f => f.name === file.name)) {
                        uploadedFiles[section].push(file);
                        addFileToList(file, listDiv, section);
                    }
                });
            });
        }

        function addFileToList(file, listDiv, section) {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                <span>${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)</span>
                <button onclick="removeFile('${file.name}', '${section}', this)" style="background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">åˆ é™¤</button>
            `;
            listDiv.appendChild(fileItem);
        }

        function removeFile(fileName, section, button) {
            uploadedFiles[section] = uploadedFiles[section].filter(f => f.name !== fileName);
            button.parentElement.remove();
        }

        // åˆå§‹åŒ–æ–‡ä»¶ä¸Šä¼ 
        setupFileUpload('smt-files', 'smt-file-list', 'smt');
        setupFileUpload('wire-bonding-files', 'wire-bonding-file-list', 'wire_bonding');
        setupFileUpload('lens-coupling-files', 'lens-coupling-file-list', 'lens_coupling');
        setupFileUpload('sn-mapping-files', 'sn-mapping-file-list', 'sn_mapping');
        setupFileUpload('test-results-files', 'test-results-file-list', 'test_results');

        // æ‹–æ‹½ä¸Šä¼ 
        document.querySelectorAll('.upload-area').forEach(area => {
            area.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('dragover');
            });

            area.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
            });

            area.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files);
                const input = this.querySelector('input[type="file"]');
                if (input) {
                    // æ¨¡æ‹Ÿæ–‡ä»¶é€‰æ‹©äº‹ä»¶
                    const event = new Event('change');
                    Object.defineProperty(event, 'target', {
                        value: { files: files },
                        writable: false
                    });
                    input.dispatchEvent(event);
                }
            });
        });

        // æ›´æ–°é…ç½®
        function updateConfig() {
            const apiKey = document.getElementById('api-key').value.trim();
            const apiUrl = document.getElementById('api-url').value.trim();
            const model = document.getElementById('model').value.trim();
            const maxTokens = document.getElementById('max-tokens').value.trim();
            const temperature = document.getElementById('temperature').value.trim();
            const systemPrompt = document.getElementById('system-prompt').value.trim();

            // åŸºæœ¬æ ¡éªŒ
            if (!apiKey) {
                showAlert('è¯·è¾“å…¥OpenAI API Key', 'error');
                return;
            }

            if (!apiUrl) {
                showAlert('è¯·è¾“å…¥API URL', 'error');
                return;
            }

            if (!model) {
                showAlert('è¯·é€‰æ‹©æ¨¡å‹', 'error');
                return;
            }

            if (!maxTokens || maxTokens < 100 || maxTokens > 100000) {
                showAlert('è¯·è¾“å…¥æœ‰æ•ˆçš„æœ€å¤§Tokenæ•° (100-100000)', 'error');
                return;
            }

            if (!temperature || temperature < 0 || temperature > 2) {
                showAlert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ¸©åº¦å‚æ•° (0-2)', 'error');
                return;
            }

            // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
            if (!confirm('ç¡®å®šè¦ä¿å­˜é…ç½®å—ï¼Ÿ')) {
                return;
            }

            const config = {
                openai_api_key: apiKey,
                openai_api_url: apiUrl,
                model: model,
                max_tokens: parseInt(maxTokens),
                temperature: parseFloat(temperature),
                system_prompt: systemPrompt
            };

            addLogMessage('æ­£åœ¨ä¿å­˜é…ç½®...');

            fetch('/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLogMessage('é…ç½®ä¿å­˜æˆåŠŸ');
                    showAlert('é…ç½®å·²ä¿å­˜', 'success');
                    
                    // æµ‹è¯•API keyæœ‰æ•ˆæ€§
                    testApiKey(apiKey, apiUrl, model);
                } else {
                    addLogMessage('é…ç½®ä¿å­˜å¤±è´¥: ' + data.error);
                    showAlert('é…ç½®ä¿å­˜å¤±è´¥: ' + data.error, 'error');
                }
            })
            .catch(error => {
                addLogMessage('é…ç½®ä¿å­˜å‡ºé”™: ' + error.message);
                showAlert('é…ç½®ä¿å­˜å‡ºé”™: ' + error.message, 'error');
            });
        }

        // æµ‹è¯•API Keyæœ‰æ•ˆæ€§
        function testApiKey(apiKey, apiUrl, model) {
            addLogMessage('æ­£åœ¨æµ‹è¯•API Keyæœ‰æ•ˆæ€§...');
            
            fetch('/test_api_key', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    api_key: apiKey,
                    api_url: apiUrl,
                    model: model
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLogMessage('API Keyæµ‹è¯•æˆåŠŸï¼');
                    showAlert('API Keyæµ‹è¯•æˆåŠŸï¼Œå¯ä»¥ä½¿ç”¨AIåˆ†æåŠŸèƒ½', 'success');
                } else {
                    addLogMessage('API Keyæµ‹è¯•å¤±è´¥: ' + data.error);
                    showAlert('API Keyæµ‹è¯•å¤±è´¥: ' + data.error + 'ã€‚è¯·æ£€æŸ¥é…ç½®ã€‚', 'error');
                }
            })
            .catch(error => {
                addLogMessage('API Keyæµ‹è¯•å‡ºé”™: ' + error.message);
                showAlert('API Keyæµ‹è¯•å‡ºé”™: ' + error.message, 'error');
            });
        }

        // åŠ è½½å·²ä¿å­˜çš„é…ç½®
        function loadConfig() {
            fetch('/config', {
                method: 'GET'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const config = data.config;
                    if (config.openai && config.openai.api_key) {
                        document.getElementById('api-key').value = config.openai.api_key;
                    }
                    if (config.openai && config.openai.api_url) {
                        document.getElementById('api-url').value = config.openai.api_url;
                    }
                    if (config.openai && config.openai.model) {
                        document.getElementById('model').value = config.openai.model;
                    }
                    if (config.openai && config.openai.max_tokens) {
                        document.getElementById('max-tokens').value = config.openai.max_tokens;
                    }
                    if (config.openai && config.openai.temperature) {
                        document.getElementById('temperature').value = config.openai.temperature;
                    }
                    if (config.system_prompt) {
                        document.getElementById('system-prompt').value = config.system_prompt;
                    }
                    addLogMessage('é…ç½®åŠ è½½æˆåŠŸ');
                }
            })
            .catch(error => {
                addLogMessage('é…ç½®åŠ è½½å¤±è´¥: ' + error.message);
            });
        }

        // æ·»åŠ æ—¥å¿—æ¶ˆæ¯
        function addLogMessage(message) {
            const logContainer = document.getElementById('log-container');
            const logContent = document.getElementById('log-content');
            
            // æ˜¾ç¤ºæ—¥å¿—å®¹å™¨
            logContainer.style.display = 'block';
            
            // æ·»åŠ æ—¶é—´æˆ³
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            
            logContent.textContent += logEntry;
            logContent.scrollTop = logContent.scrollHeight;
        }

        // æ¸…é™¤æ—¥å¿—
        function clearLogs() {
            document.getElementById('log-content').textContent = '';
            document.getElementById('log-container').style.display = 'none';
        }

        // å®æ—¶æ—¥å¿—ç›¸å…³å˜é‡
        let autoRefreshInterval = null;
        let isAutoRefreshEnabled = false;

        // åˆ·æ–°æ—¥å¿—
        function refreshLogs() {
            addLogMessage('æ­£åœ¨åˆ·æ–°åç«¯æ—¥å¿—...');
            fetch('/logs')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const logContent = document.getElementById('log-content');
                        if (data.logs && data.logs.trim()) {
                            logContent.textContent = data.logs;
                            logContent.scrollTop = logContent.scrollHeight;
                            addLogMessage('åç«¯æ—¥å¿—åˆ·æ–°æˆåŠŸ');
                        } else {
                            addLogMessage('åç«¯æš‚æ— æ—¥å¿—è®°å½•');
                        }
                    } else {
                        addLogMessage('è·å–åç«¯æ—¥å¿—å¤±è´¥: ' + data.error);
                    }
                })
                .catch(error => {
                    addLogMessage('åˆ·æ–°æ—¥å¿—æ—¶å‡ºé”™: ' + error.message);
                });
        }

        // åˆ‡æ¢è‡ªåŠ¨åˆ·æ–°
        function toggleAutoRefresh() {
            const btn = document.getElementById('auto-refresh-btn');
            if (isAutoRefreshEnabled) {
                // åœæ­¢è‡ªåŠ¨åˆ·æ–°
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
                isAutoRefreshEnabled = false;
                btn.textContent = 'è‡ªåŠ¨åˆ·æ–°';
                btn.style.background = '#27ae60';
                addLogMessage('å·²åœæ­¢è‡ªåŠ¨åˆ·æ–°æ—¥å¿—');
            } else {
                // å¼€å§‹è‡ªåŠ¨åˆ·æ–°
                isAutoRefreshEnabled = true;
                btn.textContent = 'åœæ­¢åˆ·æ–°';
                btn.style.background = '#e74c3c';
                addLogMessage('å·²å¼€å¯è‡ªåŠ¨åˆ·æ–°æ—¥å¿— (æ¯3ç§’)');
                
                // ç«‹å³åˆ·æ–°ä¸€æ¬¡
                refreshLogs();
                
                // è®¾ç½®å®šæ—¶åˆ·æ–°
                autoRefreshInterval = setInterval(refreshLogs, 3000);
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºæ—¥å¿—å®¹å™¨
        document.addEventListener('DOMContentLoaded', function() {
            // æ˜¾ç¤ºæ—¥å¿—å®¹å™¨
            document.getElementById('log-container').style.display = 'block';
            addLogMessage('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹ç›‘æ§åç«¯æ—¥å¿—...');
            
            // åˆå§‹åŠ è½½æ—¥å¿—
            refreshLogs();
        });

        // æµ‹è¯•AIè¿æ¥
        function testAIConnection() {
            const apiKey = document.getElementById('api-key').value.trim();
            const apiUrl = document.getElementById('api-url').value.trim();
            const model = document.getElementById('model').value.trim();

            if (!apiKey) {
                showAlert('è¯·å…ˆè¾“å…¥API Key', 'error');
                return;
            }

            addLogMessage('å¼€å§‹æµ‹è¯•AIè¿æ¥...');
            
            // åˆ›å»ºæµ‹è¯•æ•°æ®
            const testData = {
                custom_prompt: "ä½ æ˜¯ä¸€ä¸ªæµ‹è¯•åŠ©æ‰‹ï¼Œè¯·ç®€å•å›å¤'æµ‹è¯•æˆåŠŸ'ã€‚"
            };

            // æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªå‡çš„åˆ†æå™¨ç»“æœç”¨äºæµ‹è¯•
            if (!window.testAnalysisResults) {
                window.testAnalysisResults = {
                    data_summary: {
                        total_samples: 10,
                        total_columns: 5,
                        numeric_columns: 3,
                        target_column: 'test_result',
                        missing_data_percent: 0
                    },
                    correlation_results: null,
                    t_test_results: {},
                    random_forest_results: null
                };
            }

            // ä¸´æ—¶è®¾ç½®åˆ†æç»“æœç”¨äºæµ‹è¯•
            fetch('/analyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(testData)
            })
            .then(response => {
                addLogMessage('æ”¶åˆ°AIæµ‹è¯•å“åº”: ' + response.status);
                return response.json();
            })
            .then(data => {
                console.log('AIæµ‹è¯•å“åº”æ•°æ®:', data);
                if (data.success) {
                    if (data.ai_analysis && !data.ai_analysis.includes('ç½‘ç»œè¯·æ±‚å¤±è´¥') && !data.ai_analysis.includes('APIé”™è¯¯') && !data.ai_analysis.includes('ç¬¬ä¸‰æ–¹APIè¿”å›')) {
                        addLogMessage('AIè¿æ¥æµ‹è¯•æˆåŠŸï¼');
                        showAlert('AIè¿æ¥æµ‹è¯•æˆåŠŸ', 'success');
                        
                        // æ˜¾ç¤ºæˆåŠŸçš„æµ‹è¯•ç»“æœ
                        const testSection = `
                            <div class="analysis-report" style="border: 2px solid #27ae60;">
                                <h3>AIè¿æ¥æµ‹è¯•ç»“æœ</h3>
                                <div style="background: #d5f4fd; padding: 10px; border-radius: 5px;">
                                    <strong>æµ‹è¯•çŠ¶æ€:</strong> æˆåŠŸ<br>
                                    <strong>AIå“åº”:</strong> ${data.ai_analysis}<br>
                                    <strong>å“åº”é•¿åº¦:</strong> ${data.ai_analysis.length} å­—ç¬¦
                                </div>
                            </div>
                        `;
                        
                        const contentDiv = document.getElementById('analysis-content');
                        contentDiv.innerHTML = testSection + contentDiv.innerHTML;
                        document.getElementById('results').style.display = 'block';
                    } else {
                        addLogMessage('AIè¿æ¥æµ‹è¯•å¤±è´¥ï¼ŒAPIå“åº”å¼‚å¸¸');
                        showAlert('ç¬¬ä¸‰æ–¹APIé…ç½®é—®é¢˜', 'error');
                        
                        // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
                        const debugSection = `
                            <div class="analysis-report" style="border: 2px solid #e74c3c;">
                                <h3>ç¬¬ä¸‰æ–¹APIè°ƒè¯•ä¿¡æ¯</h3>
                                <div style="background: #f8d7da; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px;">
                                    <strong>é—®é¢˜æè¿°:</strong> ${data.ai_analysis}<br><br>
                                    <strong>å¯èƒ½çš„è§£å†³æ–¹æ¡ˆ:</strong><br>
                                    1. æ£€æŸ¥API URLæ˜¯å¦æ­£ç¡®ï¼ˆå½“å‰: ${document.getElementById('api-url').value}ï¼‰<br>
                                    2. ç¡®è®¤API Keyæ˜¯å¦æœ‰æ•ˆä¸”æœ‰ä½™é¢<br>
                                    3. æ£€æŸ¥æ¨¡å‹åç§°æ˜¯å¦è¢«ç¬¬ä¸‰æ–¹APIæ”¯æŒï¼ˆå½“å‰: ${document.getElementById('model').value}ï¼‰<br>
                                    4. è”ç³»ç¬¬ä¸‰æ–¹APIæä¾›å•†ç¡®è®¤æœåŠ¡çŠ¶æ€<br><br>
                                    <strong>å¸¸è§ç¬¬ä¸‰æ–¹APIç«¯ç‚¹æ ¼å¼:</strong><br>
                                    - https://your-api-domain.com/v1/chat/completions<br>
                                    - https://your-api-domain.com/api/v1/chat/completions<br><br>
                                    <strong>å»ºè®®:</strong> æŸ¥çœ‹åç«¯æ—¥å¿—è·å–æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                                </div>
                            </div>
                        `;
                        
                        const contentDiv = document.getElementById('analysis-content');
                        contentDiv.innerHTML = debugSection + contentDiv.innerHTML;
                        document.getElementById('results').style.display = 'block';
                    }
                } else {
                    addLogMessage('AIè¿æ¥æµ‹è¯•å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                    showAlert('AIè¿æ¥æµ‹è¯•å¤±è´¥', 'error');
                }
            })
            .catch(error => {
                addLogMessage('AIè¿æ¥æµ‹è¯•å‡ºé”™: ' + error.message);
                showAlert('AIè¿æ¥æµ‹è¯•å‡ºé”™: ' + error.message, 'error');
            });
        }

        // ä¸Šä¼ æ–‡ä»¶
        function uploadFiles() {
            const formData = new FormData();
            let hasFiles = false;

            // æ£€æŸ¥æ–‡ä»¶é‡å¤ä¸Šä¼ åˆ°ä¸åŒç‰ˆå—
            const allFileNames = new Set();
            const duplicateFiles = [];
            
            for (const [section, files] of Object.entries(uploadedFiles)) {
                files.forEach(file => {
                    if (allFileNames.has(file.name)) {
                        duplicateFiles.push(file.name);
                    } else {
                        allFileNames.add(file.name);
                    }
                });
            }

            if (duplicateFiles.length > 0) {
                showAlert(`æ£€æµ‹åˆ°é‡å¤æ–‡ä»¶ä¸Šä¼ åˆ°ä¸åŒç‰ˆå—: ${duplicateFiles.join(', ')}ã€‚è¯·ç¡®è®¤æ¯ä¸ªæ–‡ä»¶åªä¸Šä¼ åˆ°æ­£ç¡®çš„ç‰ˆå—ã€‚`, 'error');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶ä¸Šä¼ 
            for (const [section, files] of Object.entries(uploadedFiles)) {
                if (files.length > 0) {
                    hasFiles = true;
                    files.forEach(file => {
                        formData.append(`${section}_files`, file);
                    });
                }
            }

            if (!hasFiles) {
                showAlert('è¯·è‡³å°‘ä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶', 'error');
                return;
            }

            showLoading(true);
            updateProgress(10);
            addLogMessage('å¼€å§‹ä¸Šä¼ æ–‡ä»¶...');
            
            // æ˜¾ç¤ºæ—¥å¿—å®¹å™¨
            document.getElementById('log-container').style.display = 'block';

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                updateProgress(50);
                addLogMessage('æ–‡ä»¶ä¸Šä¼ å®Œæˆï¼Œå¼€å§‹æ•°æ®åˆ†æ...');
                return response.json();
            })
            .then(data => {
                updateProgress(100);
                setTimeout(() => {
                showLoading(false);
                }, 500);
                
                if (data.success) {
                    addLogMessage('æ•°æ®åˆ†æå®Œæˆï¼');
                    showAlert('æ–‡ä»¶ä¸Šä¼ å’Œåˆæ­¥åˆ†æå®Œæˆ', 'success');
                    displayAnalysisResults(data.analysis_results);
                    
                    // æ˜¾ç¤ºAIåˆ†æä¸“åŒºå¹¶æ›´æ–°çŠ¶æ€
                    const aiSection = document.getElementById('ai-analysis-section');
                    const aiStatus = document.getElementById('ai-analysis-status');
                    const aiStatusText = document.getElementById('ai-status-text');
                    
                    aiSection.style.display = 'block';
                    aiStatus.style.display = 'block';
                    aiStatusText.textContent = 'æ•°æ®å·²ä¸Šä¼ ï¼Œå¯ä»¥å¼€å§‹AIåˆ†æ';
                    aiStatus.className = 'alert success';
                    
                    document.getElementById('ai-analyze-btn').disabled = false;
                document.getElementById('ai-stream-btn').disabled = false;
                    
                    // æ»šåŠ¨åˆ°AIåˆ†æåŒºåŸŸ
                    setTimeout(() => {
                        aiSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 500);
                } else {
                    addLogMessage('åˆ†æå¤±è´¥: ' + data.error);
                    showAlert('ä¸Šä¼ å¤±è´¥: ' + data.error, 'error');
                }
            })
            .catch(error => {
                updateProgress(0);
                showLoading(false);
                addLogMessage('ä¸Šä¼ å‡ºé”™: ' + error.message);
                showAlert('ä¸Šä¼ å‡ºé”™: ' + error.message, 'error');
            });
        }

        // AIåˆ†æ
        function analyzeWithAI() {
            const customPrompt = document.getElementById('system-prompt').value;
            
            // æ›´æ–°AIåˆ†æåŒºåŸŸçŠ¶æ€
            const aiStatus = document.getElementById('ai-analysis-status');
            const aiStatusText = document.getElementById('ai-status-text');
            const aiContent = document.getElementById('ai-analysis-content');
            
            aiStatus.style.display = 'block';
            aiStatus.className = 'alert';
            aiStatus.style.background = '#fff3cd';
            aiStatus.style.color = '#856404';
            aiStatusText.textContent = 'AIåˆ†æè¿›è¡Œä¸­ï¼Œè¯·ç¨å€™...';
            
            // æ›´æ–°AIå†…å®¹åŒºåŸŸæ˜¾ç¤ºåŠ è½½çŠ¶æ€
            aiContent.innerHTML = `
                <div style="font-size: 48px; margin-bottom: 15px;">ğŸ¤–</div>
                <div style="font-size: 16px; margin-bottom: 10px; color: #f39c12;">AIæ­£åœ¨åˆ†ææ•°æ®ä¸­...</div>
                <div class="spinner" style="margin: 20px auto;"></div>
                <div style="font-size: 14px; color: #95a5a6;">è¯·è€å¿ƒç­‰å¾…ï¼Œé€šå¸¸éœ€è¦20-60ç§’</div>
            `;
            
            showLoading(true);
            updateProgress(20);
            addLogMessage('å¼€å§‹AIæ·±åº¦åˆ†æ...');
            
            // æ˜¾ç¤ºæ—¥å¿—å®¹å™¨
            document.getElementById('log-container').style.display = 'block';

            fetch('/analyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    custom_prompt: customPrompt
                })
            })
            .then(response => {
                updateProgress(80);
                addLogMessage('AIåˆ†æè¿›è¡Œä¸­...');
                return response.json();
            })
            .then(data => {
                updateProgress(100);
                setTimeout(() => {
                showLoading(false);
                }, 500);
                
                console.log('=== AIåˆ†æå“åº”å¤„ç†å¼€å§‹ ===');
                console.log('å®Œæ•´å“åº”æ•°æ®:', data);
                console.log('å“åº”æˆåŠŸçŠ¶æ€:', data.success);
                console.log('AIåˆ†æå­—æ®µå­˜åœ¨:', 'ai_analysis' in data);
                console.log('AIåˆ†æå†…å®¹:', data.ai_analysis);
                
                addLogMessage('æ”¶åˆ°AIåˆ†æå“åº”ï¼Œsuccess: ' + data.success);
                
                if (data.success) {
                    addLogMessage('AIåˆ†æå®Œæˆï¼');
                    if (data.ai_analysis) {
                        addLogMessage('AIåˆ†æå†…å®¹é•¿åº¦: ' + data.ai_analysis.length);
                        showAlert('AIåˆ†æå®Œæˆ', 'success');
                        displayAIAnalysis(data.ai_analysis);
                    } else {
                        addLogMessage('AIåˆ†æå“åº”ä¸ºç©º');
                        displayAIAnalysisError('AIåˆ†æè¿”å›ç©ºç»“æœï¼Œè¯·æ£€æŸ¥APIé…ç½®æˆ–é‡è¯•');
                    }
                    
                    if (data.analysis_results) {
                        displayAnalysisResults(data.analysis_results);
                    }
                } else {
                    const errorMessage = data.error || 'æœªçŸ¥é”™è¯¯';
                    addLogMessage('AIåˆ†æå¤±è´¥: ' + errorMessage);
                    showAlert('AIåˆ†æå¤±è´¥: ' + errorMessage, 'error');
                    displayAIAnalysisError('AIåˆ†æå¤±è´¥: ' + errorMessage);
                }
                
                console.log('=== AIåˆ†æå“åº”å¤„ç†ç»“æŸ ===');
            })
            .catch(error => {
                updateProgress(0);
                showLoading(false);
                addLogMessage('AIåˆ†æå‡ºé”™: ' + error.message);
                showAlert('AIåˆ†æå‡ºé”™: ' + error.message, 'error');
                displayAIAnalysisError('ç½‘ç»œæˆ–æœåŠ¡å™¨é”™è¯¯: ' + error.message);
            });
        }

        // AIæµå¼åˆ†æ
        function analyzeWithAIStream() {
            const customPrompt = document.getElementById('system-prompt').value;
            
            // æ›´æ–°AIåˆ†æåŒºåŸŸçŠ¶æ€
            const aiStatus = document.getElementById('ai-analysis-status');
            const aiStatusText = document.getElementById('ai-status-text');
            const aiContent = document.getElementById('ai-analysis-content');
            
            aiStatus.style.display = 'block';
            aiStatus.className = 'alert';
            aiStatus.style.background = '#fff3cd';
            aiStatus.style.color = '#856404';
            aiStatusText.textContent = 'AIæµå¼åˆ†æè¿›è¡Œä¸­ï¼Œè¯·ç¨å€™...';
            
            // æ›´æ–°AIå†…å®¹åŒºåŸŸæ˜¾ç¤ºæµå¼åŠ è½½çŠ¶æ€
            aiContent.innerHTML = `
                <div style="font-size: 48px; margin-bottom: 15px;">ğŸ¤–</div>
                <div style="font-size: 16px; margin-bottom: 10px; color: #f39c12;">AIæ­£åœ¨æµå¼åˆ†ææ•°æ®ä¸­...</div>
                <div class="spinner" style="margin: 20px auto;"></div>
                <div style="font-size: 14px; color: #95a5a6;">å†…å®¹å°†å®æ—¶æ˜¾ç¤ºï¼Œè¯·è€å¿ƒç­‰å¾…</div>
                <div id="stream-content" style="margin-top: 20px; text-align: left; white-space: pre-wrap; font-family: 'Courier New', monospace; background: #f8f9fa; padding: 15px; border-radius: 5px; max-height: 400px; overflow-y: auto; border: 1px solid #ddd;"></div>
            `;
            
            showLoading(true);
            updateProgress(20);
            addLogMessage('å¼€å§‹AIæµå¼åˆ†æ...');
            
            // æ˜¾ç¤ºæ—¥å¿—å®¹å™¨
            document.getElementById('log-container').style.display = 'block';

            // ä½¿ç”¨POSTè¯·æ±‚è¿›è¡Œæµå¼åˆ†æ
            fetch('/analyze_stream', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    custom_prompt: customPrompt
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullContent = "";
                const streamContent = document.getElementById('stream-content');
                
                function readStream() {
                    return reader.read().then(({ done, value }) => {
                        if (done) {
                            // æµå¼è¯»å–å®Œæˆ
                            updateProgress(100);
                            setTimeout(() => {
                                showLoading(false);
                            }, 500);
                            
                            // æ›´æ–°çŠ¶æ€
                            aiStatus.style.background = '#d4edda';
                            aiStatus.style.color = '#155724';
                            aiStatusText.textContent = 'AIæµå¼åˆ†æå®Œæˆ';
                            
                            // æ›´æ–°å†…å®¹åŒºåŸŸæ˜¾ç¤ºå®Œæ•´ç»“æœ
                            aiContent.innerHTML = `
                                <div style="background: white; border-radius: 8px; padding: 20px; margin-top: 15px; border: 2px solid #27ae60;">
                                    <div style="font-size: 16px; margin-bottom: 15px; color: #27ae60; font-weight: bold;">âœ… AIæµå¼åˆ†ææŠ¥å‘Š</div>
                                    <div style="white-space: pre-wrap; font-family: 'Microsoft YaHei', Arial, sans-serif; line-height: 1.6; color: #2c3e50;">${fullContent}</div>
                                </div>
                            `;
                            
                            addLogMessage('AIæµå¼åˆ†æå®Œæˆ');
                            showAlert('AIæµå¼åˆ†æå®Œæˆ', 'success');
                            return;
                        }
                        
                        const chunk = decoder.decode(value, { stream: true });
                        const lines = chunk.split('\n');
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                try {
                                    const data = JSON.parse(line.slice(6));
                                    
                                    if (data.type === 'content') {
                                        fullContent += data.content;
                                        if (streamContent) {
                                            streamContent.textContent = fullContent;
                                            streamContent.scrollTop = streamContent.scrollHeight;
                                        }
                                        updateProgress(20 + (fullContent.length / 1000) * 60); // æ ¹æ®å†…å®¹é•¿åº¦æ›´æ–°è¿›åº¦
                                    } else if (data.type === 'error') {
                                        throw new Error(data.content);
                                    }
                                } catch (error) {
                                    console.error('è§£ææµå¼æ•°æ®å‡ºé”™:', error);
                                }
                            }
                        }
                        
                        return readStream();
                    });
                }
                
                return readStream();
            })
            .catch(error => {
                updateProgress(0);
                showLoading(false);
                addLogMessage('AIæµå¼åˆ†æå‡ºé”™: ' + error.message);
                showAlert('AIæµå¼åˆ†æå‡ºé”™: ' + error.message, 'error');
                displayAIAnalysisError('æµå¼åˆ†æé”™è¯¯: ' + error.message);
            });
        }

        // æ˜¾ç¤ºåˆ†æç»“æœ
        function displayAnalysisResults(results) {
            const resultsDiv = document.getElementById('results');
            const contentDiv = document.getElementById('analysis-content');
            
            let html = '<div class="analysis-report">';
            
            // æ•°æ®æ‘˜è¦
            if (results.data_summary) {
                html += `
                    <h3>æ•°æ®æ‘˜è¦</h3>
                    <p>æ€»æ ·æœ¬æ•°: ${results.data_summary.total_samples}</p>
                    <p>æ•°æ®åˆ—æ•°: ${results.data_summary.total_columns || 0}</p>
                    <p>æ•°å€¼åˆ—æ•°: ${results.data_summary.numeric_columns || 0}</p>
                    <p>ç›®æ ‡åˆ—: ${results.data_summary.target_column || 'æœªçŸ¥'}</p>
                `;
            }
            
            // æè¿°æ€§ç»Ÿè®¡åˆ†æ
            if (results.descriptive_statistics && Object.keys(results.descriptive_statistics).length > 0) {
                html += '<h3>ğŸ“Š æè¿°æ€§ç»Ÿè®¡åˆ†æ</h3>';
                
                // ç»Ÿè®¡æœ‰æ˜æ˜¾å·®å¼‚çš„å‚æ•°
                const obviousDiffParams = [];
                const mediumDiffParams = [];
                const smallDiffParams = [];
                
                for (const [param, result] of Object.entries(results.descriptive_statistics)) {
                    const diffLevel = result.differences.difference_level;
                    const interpretation = result.interpretation;
                    
                    if (diffLevel === 'large') {
                        obviousDiffParams.push({
                            param: param,
                            mean_diff: result.differences.mean_diff,
                            pass_higher: interpretation.pass_mean_higher
                        });
                    } else if (diffLevel === 'medium') {
                        mediumDiffParams.push({
                            param: param,
                            mean_diff: result.differences.mean_diff,
                            pass_higher: interpretation.pass_mean_higher
                        });
                    } else if (diffLevel === 'small') {
                        smallDiffParams.push({
                            param: param,
                            mean_diff: result.differences.mean_diff,
                            pass_higher: interpretation.pass_mean_higher
                        });
                    }
                }
                
                html += '<div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0;">';
                html += `<p><strong>åˆ†æå‚æ•°æ€»æ•°:</strong> ${Object.keys(results.descriptive_statistics).length}</p>`;
                
                if (obviousDiffParams.length > 0) {
                    html += `<p style="color: #e74c3c;"><strong>ğŸ”´ å­˜åœ¨å¤§å·®å¼‚çš„å‚æ•° (${obviousDiffParams.length}ä¸ª):</strong></p><ul>`;
                    obviousDiffParams.forEach(item => {
                        const direction = item.pass_higher ? 'PASSç»„æ›´é«˜' : 'FAILç»„æ›´é«˜';
                        html += `<li>${item.param} (å·®å€¼: ${item.mean_diff.toFixed(3)}, ${direction})</li>`;
                    });
                    html += '</ul>';
                }
                
                if (mediumDiffParams.length > 0) {
                    html += `<p style="color: #f39c12;"><strong>ğŸŸ¡ å­˜åœ¨ä¸­ç­‰å·®å¼‚çš„å‚æ•° (${mediumDiffParams.length}ä¸ª):</strong></p><ul>`;
                    mediumDiffParams.forEach(item => {
                        const direction = item.pass_higher ? 'PASSç»„æ›´é«˜' : 'FAILç»„æ›´é«˜';
                        html += `<li>${item.param} (å·®å€¼: ${item.mean_diff.toFixed(3)}, ${direction})</li>`;
                    });
                    html += '</ul>';
                }
                
                if (smallDiffParams.length > 0) {
                    html += `<p style="color: #3498db;"><strong>ğŸ”µ å­˜åœ¨å°å·®å¼‚çš„å‚æ•° (${smallDiffParams.length}ä¸ª):</strong></p>`;
                    html += `<details><summary>ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</summary><ul>`;
                    smallDiffParams.forEach(item => {
                        const direction = item.pass_higher ? 'PASSç»„æ›´é«˜' : 'FAILç»„æ›´é«˜';
                        html += `<li>${item.param} (å·®å€¼: ${item.mean_diff.toFixed(3)}, ${direction})</li>`;
                    });
                    html += '</ul></details>';
                }
                
                const totalWithDifferences = obviousDiffParams.length + mediumDiffParams.length + smallDiffParams.length;
                html += `<p><strong>åˆæ­¥åˆ¤æ–­:</strong> ${totalWithDifferences > 0 ? 
                    `åœ¨${Object.keys(results.descriptive_statistics).length}ä¸ªå‚æ•°ä¸­ï¼Œæœ‰${totalWithDifferences}ä¸ªå‚æ•°åœ¨Pass/Failç»„ä¹‹é—´å­˜åœ¨å·®å¼‚` : 
                    'æœªå‘ç°æ˜æ˜¾çš„å‚æ•°å·®å¼‚'}</p>`;
                
                html += '</div>';
            }
            
            // ç›¸å…³æ€§åˆ†æå›¾
            if (results.correlation_plot) {
                html += `
                    <div class="chart-container">
                        <h3>ç›¸å…³æ€§åˆ†æ</h3>
                        <img src="/download/correlation_matrix.png" alt="ç›¸å…³æ€§çŸ©é˜µ">
                    </div>
                `;
            }
            
            // Tæ£€éªŒç»“æœ
            if (results.t_test_results && Object.keys(results.t_test_results).length > 0) {
                html += '<h3>Tæ£€éªŒåˆ†æç»“æœ</h3><ul>';
                for (const [param, result] of Object.entries(results.t_test_results)) {
                    const significant = result.significant ? 'æ˜¾è‘—' : 'ä¸æ˜¾è‘—';
                    html += `<li>${param}: på€¼=${result.p_value.toFixed(4)} (${significant})</li>`;
                }
                html += '</ul>';
            }
            
            // éšæœºæ£®æ—åˆ†æ
            if (results.random_forest_results && results.rf_plot) {
                html += `
                    <div class="chart-container">
                        <h3>éšæœºæ£®æ—ç‰¹å¾é‡è¦æ€§åˆ†æ</h3>
                        <img src="/download/random_forest_importance.png" alt="ç‰¹å¾é‡è¦æ€§">
                        <p>æ¨¡å‹å‡†ç¡®ç‡: ${(results.random_forest_results.model_score * 100).toFixed(2)}%</p>
                    </div>
                `;
            }
            
            html += '</div>';
            contentDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        }

        // æ˜¾ç¤ºAIåˆ†æç»“æœ - æ–°çš„ä¸“å±åŒºåŸŸç‰ˆæœ¬
        function displayAIAnalysis(analysis) {
            console.log('=== AIåˆ†ææ˜¾ç¤ºå¼€å§‹ï¼ˆæ–°ç‰ˆæœ¬ï¼‰===');
            addLogMessage('å¼€å§‹æ˜¾ç¤ºAIåˆ†æç»“æœï¼Œé•¿åº¦: ' + (analysis ? analysis.length : 0));
            
            const aiStatus = document.getElementById('ai-analysis-status');
            const aiStatusText = document.getElementById('ai-status-text');
            const aiContent = document.getElementById('ai-analysis-content');
            
            if (!analysis || analysis.trim() === '') {
                displayAIAnalysisError('AIåˆ†æè¿”å›ç©ºç»“æœï¼Œè¯·æ£€æŸ¥APIé…ç½®æˆ–é‡è¯•');
                return;
            }
            
            // æ›´æ–°çŠ¶æ€ä¸ºæˆåŠŸ
            aiStatus.style.display = 'block';
            aiStatus.className = 'alert success';
            aiStatusText.innerHTML = `AIåˆ†æå®Œæˆï¼å†…å®¹é•¿åº¦: ${analysis.length} å­—ç¬¦ | å®Œæˆæ—¶é—´: ${new Date().toLocaleTimeString()}`;
            
            // å¤„ç†Markdownæ ¼å¼
            let processedAnalysis = analysis
                .replace(/### (.*?)$/gm, '<h4 style="color: #34495e; margin-top: 15px; margin-bottom: 8px;">$1</h4>')
                .replace(/## (.*?)$/gm, '<h3 style="color: #2c3e50; margin-top: 20px; margin-bottom: 10px; border-bottom: 2px solid #3498db; padding-bottom: 5px;">$1</h3>')
                .replace(/# (.*?)$/gm, '<h2 style="color: #2c3e50; margin-top: 25px; margin-bottom: 15px; border-bottom: 3px solid #3498db; padding-bottom: 8px;">$1</h2>')
                .replace(/\*\*(.*?)\*\*/g, '<strong style="color: #2980b9;">$1</strong>')
                .replace(/^- (.*?)$/gm, '<li style="margin: 5px 0; list-style-type: disc;">$1</li>')
                .replace(/\n\n/g, '<br><br>')
                .replace(/\n/g, '<br>');
            
            // åŒ…è£…è¿ç»­çš„åˆ—è¡¨é¡¹ä¸ºul
            processedAnalysis = processedAnalysis.replace(/(<li[^>]*>.*?<\/li><br>)*<li[^>]*>.*?<\/li>/g, '<ul style="margin: 10px 0; padding-left: 20px;">$&</ul>');
            
            // æ›´æ–°AIå†…å®¹åŒºåŸŸ
            aiContent.style.textAlign = 'left';
            aiContent.style.border = '2px solid #27ae60';
            aiContent.style.minHeight = 'auto';
            aiContent.style.display = 'block';
            
            aiContent.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #e8f5e8 0%, #d5f4d5 100%);
                    padding: 15px;
                    margin-bottom: 20px;
                    border-radius: 8px;
                    border-left: 6px solid #27ae60;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                ">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <span style="font-size: 24px; margin-right: 10px;">âœ…</span>
                        <strong style="color: #27ae60; font-size: 16px;">AIåˆ†æå·²æˆåŠŸå®Œæˆ</strong>
                    </div>
                    ğŸ“Š <strong>åˆ†æå†…å®¹é•¿åº¦:</strong> ${analysis.length} å­—ç¬¦<br>
                    â° <strong>å®Œæˆæ—¶é—´:</strong> ${new Date().toLocaleString()}<br>
                    ğŸ” <strong>æç¤º:</strong> å¦‚éœ€ä¸‹è½½å®Œæ•´å†…å®¹ï¼Œè¯·åœ¨æµè§ˆå™¨æ§åˆ¶å°è¿è¡Œ: <code style="background: #fff; padding: 2px 4px; border-radius: 3px; color: #e74c3c;">window.downloadAIAnalysis()</code>
                </div>
                <div style="
                    background: white; 
                    padding: 20px; 
                    border-radius: 8px; 
                    border: 1px solid #e0e0e0;
                    line-height: 1.8;
                    font-size: 15px;
                ">
                    ${processedAnalysis}
                </div>
            `;
            
            // æ›´æ–°sectionçš„è¾¹æ¡†é¢œè‰²è¡¨ç¤ºæˆåŠŸ
            const aiSection = document.getElementById('ai-analysis-section');
            aiSection.style.borderLeftColor = '#27ae60';
            
            // æ·»åŠ é¡µé¢é¡¶éƒ¨é€šçŸ¥æ¡
            showAICompletionNotification();
            
            // æ»šåŠ¨åˆ°AIåˆ†æåŒºåŸŸ
            setTimeout(() => {
                aiSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                // æ·»åŠ é—ªçƒæ•ˆæœçªå‡ºæ˜¾ç¤º
                aiSection.style.animation = 'highlight 2s ease-in-out';
            }, 500);
            
            // ä¿å­˜åˆ†æå†…å®¹åˆ°æœ¬åœ°å­˜å‚¨
            setupAIAnalysisDebugTools(analysis, processedAnalysis);
            
            addLogMessage('AIåˆ†æç»“æœæ˜¾ç¤ºå®Œæˆï¼Œå·²æ»šåŠ¨åˆ°AIä¸“å±åŒºåŸŸ');
            console.log('=== AIåˆ†ææ˜¾ç¤ºç»“æŸï¼ˆæ–°ç‰ˆæœ¬ï¼‰===');
        }
        
        // æ˜¾ç¤ºAIåˆ†æé”™è¯¯
        function displayAIAnalysisError(errorMessage) {
            console.log('æ˜¾ç¤ºAIåˆ†æé”™è¯¯:', errorMessage);
            
            const aiStatus = document.getElementById('ai-analysis-status');
            const aiStatusText = document.getElementById('ai-status-text');
            const aiContent = document.getElementById('ai-analysis-content');
            
            // æ›´æ–°çŠ¶æ€ä¸ºé”™è¯¯
            aiStatus.style.display = 'block';
            aiStatus.className = 'alert error';
            aiStatusText.textContent = 'AIåˆ†æå¤±è´¥';
            
            // æ›´æ–°å†…å®¹åŒºåŸŸæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            aiContent.style.textAlign = 'center';
            aiContent.style.border = '2px solid #e74c3c';
            aiContent.innerHTML = `
                <div style="font-size: 48px; margin-bottom: 15px;">âŒ</div>
                <div style="font-size: 16px; margin-bottom: 10px; color: #e74c3c;">AIåˆ†æå¤±è´¥</div>
                <div style="font-size: 14px; color: #95a5a6; margin-bottom: 20px;">${errorMessage}</div>
                <button onclick="analyzeWithAI()" style="
                    background: #3498db;
                    color: white;
                    padding: 10px 20px;
                    border: none;
                    border-radius: 5px;
                    cursor: pointer;
                    font-size: 14px;
                ">ğŸ”„ é‡è¯•AIåˆ†æ</button>
            `;
            
            // æ›´æ–°sectionçš„è¾¹æ¡†é¢œè‰²è¡¨ç¤ºé”™è¯¯
            const aiSection = document.getElementById('ai-analysis-section');
            aiSection.style.borderLeftColor = '#e74c3c';
            
            // æ»šåŠ¨åˆ°AIåˆ†æåŒºåŸŸ
            setTimeout(() => {
                aiSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 500);
        }
        
        // æ˜¾ç¤ºAIå®Œæˆé€šçŸ¥
        function showAICompletionNotification() {
            // ç§»é™¤å·²å­˜åœ¨çš„é€šçŸ¥æ¡
            const existingNotification = document.getElementById('ai-notification-bar');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            const notificationBar = document.createElement('div');
            notificationBar.id = 'ai-notification-bar';
            notificationBar.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
                color: white;
                padding: 15px;
                text-align: center;
                font-size: 16px;
                font-weight: bold;
                z-index: 10000;
                box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                animation: slideDown 0.5s ease-out;
            `;
            notificationBar.innerHTML = `
                ğŸ‰ AIåˆ†ææŠ¥å‘Šå·²ç”Ÿæˆå®Œæˆï¼è¯·æŸ¥çœ‹ä¸‹æ–¹ä¸“å±åˆ†æåŒºåŸŸ ğŸ‰
                <button onclick="document.getElementById('ai-analysis-section').scrollIntoView({behavior: 'smooth', block: 'start'})" style="
                    background: rgba(255,255,255,0.9);
                    border: none;
                    color: #27ae60;
                    padding: 8px 16px;
                    border-radius: 20px;
                    cursor: pointer;
                    margin: 0 10px;
                    font-weight: bold;
                    transition: all 0.3s ease;
                " onmouseover="this.style.background='white'" onmouseout="this.style.background='rgba(255,255,255,0.9)'">ğŸ“ è·³è½¬åˆ°AIæŠ¥å‘Š</button>
                <button onclick="this.parentElement.remove()" style="
                    float: right;
                    background: rgba(255,255,255,0.2);
                    border: none;
                    color: white;
                    padding: 5px 10px;
                    border-radius: 3px;
                    cursor: pointer;
                    margin-left: 15px;
                ">âœ•</button>
            `;
            
            // æ·»åŠ æ»‘åŠ¨åŠ¨ç”»
            if (!document.getElementById('notification-animation')) {
                const style = document.createElement('style');
                style.id = 'notification-animation';
                style.textContent = `
                    @keyframes slideDown {
                        from { transform: translateY(-100%); }
                        to { transform: translateY(0); }
                    }
                    @keyframes highlight {
                        0%, 100% { box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
                        50% { box-shadow: 0 8px 24px rgba(39, 174, 96, 0.4); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.insertBefore(notificationBar, document.body.firstChild);
            
            // 5ç§’åè‡ªåŠ¨ç§»é™¤é€šçŸ¥æ¡
            setTimeout(() => {
                if (notificationBar && notificationBar.parentElement) {
                    notificationBar.style.animation = 'slideDown 0.5s ease-out reverse';
                    setTimeout(() => notificationBar.remove(), 500);
                }
            }, 5000);
        }
        
        // è®¾ç½®AIåˆ†æè°ƒè¯•å·¥å…·
        function setupAIAnalysisDebugTools(originalAnalysis, processedAnalysis) {
            try {
                const debugData = {
                    timestamp: new Date().toISOString(),
                    original_length: originalAnalysis ? originalAnalysis.length : 0,
                    processed_length: processedAnalysis ? processedAnalysis.length : 0,
                    original_content: originalAnalysis,
                    processed_content: processedAnalysis,
                    section_exists: !!document.getElementById('ai-analysis-section')
                };
                localStorage.setItem('ai_analysis_debug', JSON.stringify(debugData, null, 2));
                
                // åœ¨æµè§ˆå™¨æ§åˆ¶å°æä¾›æå–å‡½æ•°
                window.downloadAIAnalysis = function() {
                    const blob = new Blob([originalAnalysis], { type: 'text/plain;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'ai_analysis_' + new Date().toISOString().replace(/[:.]/g, '-') + '.txt';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                };
                
                window.scrollToAIAnalysis = function() {
                    const aiSection = document.getElementById('ai-analysis-section');
                    if (aiSection) {
                        aiSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        return true;
                    } else {
                        return false;
                    }
                };
                
                console.log('ğŸ” AIåˆ†æè°ƒè¯•å·¥å…·å·²å°±ç»ª');
                console.log('- ä¸‹è½½åˆ†æ: window.downloadAIAnalysis()');
                console.log('- æ»šåŠ¨åˆ°åˆ†æ: window.scrollToAIAnalysis()');
            } catch (e) {
                console.error('è®¾ç½®è°ƒè¯•å·¥å…·å¤±è´¥:', e);
            }
        }

        // å·¥å…·å‡½æ•°
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
            document.getElementById('progress-bar').style.display = show ? 'block' : 'none';
        }

        function updateProgress(percent) {
            document.getElementById('progress-fill').style.width = percent + '%';
        }

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;
            alertContainer.innerHTML = '';
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨
        function fetchAvailableModels() {
            const apiKey = document.getElementById('api-key').value;
            const apiUrl = document.getElementById('api-url').value;
            
            if (!apiKey) {
                showAlert('è¯·å…ˆè¾“å…¥API Key', 'error');
                return;
            }
            
            addLogMessage('æ­£åœ¨è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨...');
            
            fetch('/get_models', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    api_key: apiKey,
                    api_url: apiUrl
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const modelSelect = document.getElementById('model');
                    const currentValue = modelSelect.value;
                    
                    // æ¸…ç©ºç°æœ‰é€‰é¡¹
                    modelSelect.innerHTML = '';
                    
                    // æ·»åŠ æ–°é€‰é¡¹
                    data.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.id;
                        option.textContent = model.name;
                        modelSelect.appendChild(option);
                    });
                    
                    // å°è¯•æ¢å¤ä¹‹å‰çš„é€‰æ‹©
                    if (currentValue) {
                        modelSelect.value = currentValue;
                    }
                    
                    addLogMessage(`æˆåŠŸè·å–åˆ° ${data.models.length} ä¸ªå¯ç”¨æ¨¡å‹`);
                    if (data.warning) {
                        addLogMessage(`è­¦å‘Š: ${data.warning}`);
                    }
                    showAlert(`æˆåŠŸè·å–åˆ° ${data.models.length} ä¸ªæ¨¡å‹`, 'success');
                } else {
                    addLogMessage('è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥: ' + data.error);
                    showAlert('è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥: ' + data.error, 'error');
                }
            })
            .catch(error => {
                addLogMessage('è·å–æ¨¡å‹åˆ—è¡¨å‡ºé”™: ' + error.message);
                showAlert('è·å–æ¨¡å‹åˆ—è¡¨å‡ºé”™: ' + error.message, 'error');
            });
        }

        // è®¾ç½®APIé¢„è®¾é…ç½®
        function setApiPreset(preset) {
            const apiUrlInput = document.getElementById('api-url');
            const modelInput = document.getElementById('model');
            
            switch(preset) {
                case 'openai':
                    apiUrlInput.value = 'https://api.openai.com/v1/chat/completions';
                    modelInput.value = 'gpt-4';
                    addLogMessage('å·²è®¾ç½®OpenAIå®˜æ–¹APIé…ç½®');
                    break;
                case 'aigcbest':
                    apiUrlInput.value = 'https://api2.aigcbest.top/v1/chat/completions';
                    modelInput.value = 'gpt-4o-mini';
                    addLogMessage('å·²è®¾ç½®AIå·¥å‚APIé…ç½®');
                    break;
                case 'chatanywhere':
                    apiUrlInput.value = 'https://api.chatanywhere.com.cn/v1/chat/completions';
                    modelInput.value = 'gpt-3.5-turbo';
                    addLogMessage('å·²è®¾ç½®ChatAnyWhere APIé…ç½®');
                    break;
                case 'api2d':
                    apiUrlInput.value = 'https://openai.api2d.net/v1/chat/completions';
                    modelInput.value = 'gpt-3.5-turbo';
                    addLogMessage('å·²è®¾ç½®API2Dé…ç½®');
                    break;
                case 'custom':
                    addLogMessage('è¯·æ‰‹åŠ¨è¾“å…¥è‡ªå®šä¹‰APIé…ç½®');
                    break;
                default:
                    break;
            }
        }

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            addLogMessage('é¡µé¢åŠ è½½å®Œæˆ');
            loadConfig();
        });
    </script>
</body>
</html>